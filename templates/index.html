<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <title>Útdíj Kalkulátor 2025–2026 – Teljes verzió</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #d00; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; margin-right: 10px; }
        select, input, button { padding: 10px; font-size: 16px; margin: 5px; border-radius: 8px; border: 1px solid #ccc; }
        button { background: #d00; color: white; cursor: pointer; }
        button:hover { background: #b00000; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        #map { height: 560px; margin: 20px 0; border: 3px solid #333; border-radius: 12px; }
        .result { padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 18px; line-height: 1.8; }

        /* Dinamikus pontok */
        .pont-container { margin: 15px 0; }
        .pont { display: flex; align-items: center; margin: 8px 0; }
        .pont input { flex: 1; width: 400px; }
        .pont button.torol { background: #c33; margin-left: 8px; padding: 10px 12px; }
        .pont input.valid { border: 2px solid green; }
        .pont input.invalid { border: 2px solid red; }
        .pont input:placeholder-shown { border: 1px solid #ccc; }
        #ujpont { background: #080; }
        #ujpont:hover { background: #060; }
    </style>
</head>
<body>

<h1>Hivatalos Útdíj Kalkulátor 2025–2026</h1>

<div class="controls">
    <label>Útvonal via-pontjai:</label><br>
    <div id="pontok">
        <div class="pont">
            <input type="text" class="telepules" placeholder="Indulási település (pl. Budapest)" autocomplete="off">
            <button type="button" class="torol" style="display:none;">Töröl</button>
        </div>
        <div class="pont">
            <input type="text" class="telepules" placeholder="Érkezési település (pl. Szeged)" autocomplete="off">
            <button type="button" class="torol" style="display:none;">Töröl</button>
        </div>
    </div>
    <button id="ujpont">+ Új pont hozzáadása</button>

    <div style="margin-top: 20px;">
        <label>Év:</label>
        <select id="ev">
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
        </select>

        <label>Kategória:</label>
        <select id="kategoria">
            <option value="J2">J2 – 2 tengely</option>
            <option value="J3">J3 – 3 tengely</option>
            <option value="J4">J4 – 4 tengely</option>
            <option value="J5" selected>J5 – 5 vagy több tengely</option>
        </select>

        <label>Környezetvédelmi besorolás:</label>
        <select id="euro">
            <option value="EURO0">EURO 0</option>
            <option value="EURO1">EURO I</option>
            <option value="EURO2">EURO II</option>
            <option value="EURO3">EURO III</option>
            <option value="EURO4">EURO IV</option>
            <option value="EURO5">EURO V</option>
            <option value="EURO6" selected>EURO VI</option>
            <option value="ALACSONY">Alacsony kibocsátású</option>
            <option value="ZERO">Kibocsátásmentes</option>
        </select>

        <label>Nettó/Bruttó:</label>
        <select id="netto_brutto">
            <option value="netto" selected>Nettó</option>
            <option value="brutto">Bruttó</option>
        </select>

        <button id="szamol" disabled>Számol</button>
        <button onclick="torles()">Törlés</button>
    </div>
</div>

<div id="map"></div>
<div id="eredmeny" class="result">Írd be az útvonalat és állítsd be a paramétereket, majd nyomd meg a <b>Számol</b> gombot!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.pm@latest/dist/leaflet.pm.min.js"></script>
<script>
    const map = L.map('map').setView([46.8, 18.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];
    let routeLayer = null;
    let coords = [];

    document.getElementById('ujpont').addEventListener('click', () => {
        const container = document.getElementById('pontok');
        const div = document.createElement('div');
        div.className = 'pont';
        div.innerHTML = `<input type="text" class="telepules" placeholder="Település neve" autocomplete="off">
                         <button type="button" class="torol">Töröl</button>`;
        container.appendChild(div);
        div.querySelector('.torol').addEventListener('click', () => div.remove());
        div.querySelector('.telepules').addEventListener('blur', validateAndUpdate);
    });

    document.querySelectorAll('.torol').forEach(btn => {
        btn.style.display = 'inline';
        btn.addEventListener('click', (e) => e.target.parentElement.remove());
    });

    document.querySelectorAll('.telepules').forEach(input => {
        input.addEventListener('blur', validateAndUpdate);
    });

    function validateAndUpdate() {
        updateRoute();
    }

    async function updateRoute() {
        clearMap();
        coords = [];
        let valid = true;

        for (let input of document.querySelectorAll('.telepules')) {
            const query = input.value.trim();
            if (!query) continue;

            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Magyarország')}`);
            const data = await resp.json();

            if (data.length > 0) {
                const loc = data[0];
                const lat = parseFloat(loc.lat);
                const lon = parseFloat(loc.lon);
                coords.push([lat, lon]);
                L.marker([lat, lon]).addTo(map).bindPopup(loc.display_name);
                input.classList.remove('invalid');
                input.classList.add('valid');
            } else {
                input.classList.remove('valid');
                input.classList.add('invalid');
                valid = false;
            }
        }

        if (coords.length >= 2 && valid) {
            const osrmCoords = coords.map(c => c[1] + ',' + c[0]).join(';');
            const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${osrmCoords}?overview=full&geometries=geojson`;
            const osrmResp = await fetch(osrmUrl);
            const osrmData = await osrmResp.json();

            if (osrmData.routes) {
                const geometry = osrmData.routes[0].geometry;
                const routeCoords = geometry.coordinates.map(c => [c[1], c[0]]); // Convert to [lat, lon]
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.polyline(routeCoords, {color: 'red'}).addTo(map);
                map.fitBounds(routeLayer.getBounds());

                // Húzhatóvá tesszük a polyline-t
                routeLayer.pm.enable({ draggable: true, snappable: false });
                routeLayer.on('pm:dragend', () => {
                    const newCoords = routeLayer.getLatLngs();
                    // Opcionálisan frissítheted a coords-ot vagy újraszámolhatsz
                });

                document.getElementById('szamol').disabled = false;
            }
        } else {
            document.getElementById('szamol').disabled = true;
        }
    }

    function clearMap() {
        markers.forEach(m => map.removeLayer(m));
        if (routeLayer) map.removeLayer(routeLayer);
        markers = [];
        routeLayer = null;
    }

    document.getElementById('szamol').addEventListener('click', async () => {
        const serverCoords = coords.map(c => [c[1], c[0]]); // [lon, lat] a szervernek
        const resp = await fetch('/szamol_telepulesekkel', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({coords: serverCoords})
        });
        const data = await resp.json();
        document.getElementById('eredmeny').textContent = `Fizetendő díj: ${data.dij} Ft`;
    });
</script>
</body>
</html>