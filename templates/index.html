<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="utf-8">
    <title>Útdíj Kalkulátor 2026 – Teljes verzió</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
        h1 { color: #d00; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { font-weight: bold; margin-right: 10px; }
        select, input, button { padding: 10px; font-size: 16px; margin: 5px; border-radius: 8px; border: 1px solid #ccc; }
        button { background: #d00; color: white; cursor: pointer; }
        button:hover { background: #b00000; }
        #map { height: 560px; margin: 20px 0; border: 3px solid #333; border-radius: 12px; }
        .result { padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-size: 18px; line-height: 1.8; }
    </style>
</head>
<body>

<h1>Hivatalos Útdíj Kalkulátor 2025–2026</h1>

<div class="controls">
    <label>Útvonal:</label>
    <input type="text" id="telepulesek" placeholder="Pl. Budapest → Szeged → Pécs" style="width: 420px;" value="Szekszárd → Cece → Nemesszalók">

    <br><br>

    <label>Év:</label>
    <select id="ev">
        <option value="2025">2025</option>
        <option value="2026" selected>2026</option>
    </select>

    <label>Kategória:</label>
    <select id="kategoria">
        <option value="J2">J2 – 2 tengely</option>
        <option value="J3">J3 – 3 tengely</option>
        <option value="J4">J4 – 4 tengely</option>
        <option value="J5" selected>J5 – 5 vagy több tengely</option>
    </select>

    <label>Környezetvédelmi besorolás:</label>
    <select id="euro">
        <option value="EURO0">EURO 0</option>
        <option value="EURO1">EURO I</option>
        <option value="EURO2">EURO II</option>
        <option value="EURO3">EURO III</option>
        <option value="EURO4">EURO IV</option>
        <option value="EURO5">EURO V</option>
        <option value="EURO6" selected>EURO VI</option>
        <option value="ALACSONY">Alacsony kibocsátású</option>
        <option value="ZERO">Kibocsátásmentes</option>
    </select>

    <label>Nettó/Bruttó:</label>
    <select id="netto_brutto">
        <option value="netto" selected>Nettó</option>
        <option value="brutto">Bruttó</option>
    </select>

    <button onclick="kereses()">Számol</button>
    <button onclick="document.getElementById('telepulesek').value=''; torles();">Törlés</button>
</div>

<div id="map"></div>
<div id="eredmeny" class="result">Írd be az útvonalat és állítsd be a paramétereket, majd nyomd meg a <b>Számol</b> gombot!</div>

<script>
    const map = L.map('map').setView([46.8, 18.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markerek = [];

    function torles() {
        markerek.forEach(m => map.removeLayer(m));
        markerek = [];
    }

    async function kereses() {
        const input = document.getElementById('telepulesek').value.trim();
        if (!input) return alert("Írj be útvonalat!");

        const ev = document.getElementById('ev').value;
        const kategoria = document.getElementById('kategoria').value;
        const euro = document.getElementById('euro').value;
        const netto_brutto = document.getElementById('netto_brutto').value;

        const telepulesek = input.split('→').map(t => t.trim()).filter(t => t);
        if (telepulesek.length < 2) return alert("Legalább két település kell!");

        torles();
        document.getElementById('eredmeny').innerHTML = "Keresés és számítás folyamatban...";

        const pontok = [];
        for (let hely of telepulesek) {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(hely + ", Magyarország")}&limit=1`);
            const data = await resp.json();
            if (data && data[0]) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                const marker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${hely}</b>`).openPopup();
                markerek.push(marker);
                pontok.push({ lat, lon });
                if (pontok.length === 1) map.setView([lat, lon], 10);
            } else {
                alert(`Nem találtam: ${hely}`);
                return;
            }
        }

        L.polyline(pontok.map(p => [p.lat, p.lon]), {color: 'red', weight: 5}).addTo(map);

        fetch('/szamol_telepulesekkel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                pontok: pontok,
                ev: parseInt(ev),
                kategoria: kategoria,
                euro: euro,
                netto_brutto: netto_brutto
            })
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('eredmeny').innerHTML = data.eredmeny || data.hiba;
        });
    }
</script>
</body>
</html>